version: "2.1"

dependencies: ./project-dependencies-quarkus.yaml

pre: |
  export BUILD_MVN_OPTS="${{ env.BUILD_MVN_OPTS }} -nsu -ntp -fae -e -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.httpconnectionManager.ttlSeconds=120 -Dmaven.wagon.http.retryHandler.count=3"
  echo "BUILD_MVN_OPTS=${{ env.BUILD_MVN_OPTS }}"
  export BUILD_MVN_OPTS_CURRENT="${{ env.BUILD_MVN_OPTS_CURRENT }} -Dversion.io.quarkus=999-SNAPSHOT"
  echo "BUILD_MVN_OPTS_CURRENT=${{ env.BUILD_MVN_OPTS_CURRENT }}"

default:
  build-command:
    current: mvn dependency:tree clean install ${{ env.BUILD_MVN_OPTS }} ${{ env.BUILD_MVN_OPTS_CURRENT }}
    upstream: mvn dependency:tree clean install -Dquickly ${{ env.BUILD_MVN_OPTS }} ${{ env.BUILD_MVN_OPTS_UPSTREAM }}
    after:
      current: |
        docker system prune -f

build:
  - project: kiegroup/kogito-runtimes
    build-command:
      # `-Dquarkus.bootstrap.effective-model-builder` is a temporary fix due to quarkus resolver on tests
      # https://github.com/quarkusio/quarkus/issues/23205
      current: |
        mvn -f kogito-runtimes/pom.xml dependency:tree clean install -Dversion.io.quarkus.quarkus-test-maven=999-SNAPSHOT -Dquarkus.bootstrap.effective-model-builder ${{ env.BUILD_MVN_OPTS }} ${{ env.BUILD_MVN_OPTS_CURRENT }} ${{ env.KOGITO_RUNTIMES_BUILD_MVN_OPTS }}
      upstream: mvn dependency:tree clean install -Dquickly -Dversion.io.quarkus.quarkus-test-maven=999-SNAPSHOT ${{ env.BUILD_MVN_OPTS }} ${{ env.BUILD_MVN_OPTS_UPSTREAM }} ${{ env.KOGITO_RUNTIMES_BUILD_MVN_OPTS_UPSTREAM }}
    clone:
      - kogito-runtimes

  - project: kiegroup/kogito-examples
    build-command: 
      current: |
        mvn -f kogito-examples/pom.xml dependency:tree clean install -Dquarkus.platform.version=999-SNAPSHOT ${{ env.BUILD_MVN_OPTS }} ${{ env.BUILD_MVN_OPTS_CURRENT }} ${{ env.KOGITO_EXAMPLES_BUILD_MVN_OPTS }}
      upstream: mvn dependency:tree clean install -Dquickly -Dquarkus.platform.version=999-SNAPSHOT ${{ env.BUILD_MVN_OPTS }} ${{ env.BUILD_MVN_OPTS_UPSTREAM }} ${{ env.KOGITO_EXAMPLES_BUILD_MVN_OPTS_UPSTREAM }}
    clone:
      - kogito-examples

  - project: quarkusio/quarkus
    build-command:
      upstream: mvn dependency:tree clean install -fae -Dquickly ${{ env.BUILD_MVN_OPTS }}
